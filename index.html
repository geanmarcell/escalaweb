<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escala de Trabalho</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/pt-br.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        .escala-visual-menor {
            font-size: 11px;
        }
        /* Ajuste para o popup ser responsivo e com rolagem interna se necessário */
        #popup .popup-content {
            max-height: 90vh;
            overflow-y: auto;
        }
        @media (max-width: 768px) {
            #popup .popup-content {
                max-width: 98vw;
                padding: 1rem;
            }
        }
        /* Tema profissional e compacto */
        body, input, select, textarea, table, th, td, button, label, small, .escala-visual-menor {
            font-size: 13px !important;
            font-family: 'Segoe UI', Arial, sans-serif;
            color: #1a1a1a;
        }
        h1, h2, h3, h4, h5, h6, .text-2xl, .text-xl, .text-lg, .font-bold, .font-semibold {
            font-size: revert !important;
            font-family: 'Segoe UI', Arial, sans-serif;
            letter-spacing: -0.02em;
        }
        .bg-white {
            background-color: #ffffff !important;
        }
        .shadow, .shadow-lg {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important;
        }
        .rounded, .rounded-lg {
            border-radius: 8px !important;
        }
        .p-4, .p-6 {
            padding: 12px !important;
        }
        .mb-4, .mb-6, .mb-8 {
            margin-bottom: 12px !important;
        }
        .gap-4, .gap-2 {
            gap: 8px !important;
        }
        .p-2, .px-4, .py-2, .px-5, .py-4, .px-6, .py-6, .p-3 {
            padding: 6px !important;
        }
        input, select, button, textarea {
            border-radius: 4px !important;
            border: 1px solid #d1d5db !important;
            padding: 6px 8px !important;
        }
        input:focus, select:focus, textarea:focus {
            outline: 1px solid #2563eb !important;
            border-color: #2563eb !important;
        }
        th, td {
            padding: 6px !important;
        }
        .table, .w-full {
            margin-bottom: 0 !important;
        }
        label {
            margin-bottom: 2px !important;
            font-weight: 500;
        }
        button {
            font-size: 11px !important;
            padding: 6px 12px !important;
            border-radius: 4px !important;
        }
        .flex, .flex-1, .items-center, .justify-between, .justify-center {
            gap: 0 !important;
        }
        .bg-blue-600, .hover\:bg-blue-700, .bg-blue-500, .hover\:bg-blue-600, .bg-blue-100, .hover\:bg-blue-300 {
            background-color: #2563eb !important;
            color: #fff !important;
        }
        .bg-red-500, .hover\:bg-red-600, .bg-red-100 {
            background-color: #e11d48 !important;
            color: #fff !important;
        }
        .bg-yellow-500, .hover\:bg-yellow-600, .bg-yellow-100 {
            background-color: #f59e42 !important;
            color: #fff !important;
        }
        .text-blue-700, .text-blue-800, .text-blue-900 {
            color: #1e293b !important;
        }
        .text-gray-600, .text-gray-500, .text-gray-700, .text-gray-900 {
            color: #475569 !important;
        }
        .border, .border-gray-300, .border-gray-200 {
            border: 1px solid #e5e7eb !important;
        }
        .bg-gray-100, .bg-gray-200 {
            background-color: #f3f4f6 !important;
        }
        .bg-green-500, .bg-green-600, .bg-green-300 {
            background-color: #22c55e !important;
            color: #fff !important;
        }
        .bg-orange-400 {
            background-color: #fb923c !important;
            color: #fff !important;
        }
        .bg-gray-700 {
            background-color: #334155 !important;
            color: #fff !important;
        }
        .text-red-500 {
            color: #e11d48 !important;
        }
        .text-xs {
            font-size: 11px !important;
        }
        .text-sm {
            font-size: 12px !important;
        }
        .text-base {
            font-size: 13px !important;
        }
        .text-lg {
            font-size: 15px !important;
        }
        .text-xl {
            font-size: 17px !important;
        }
        .text-2xl {
            font-size: 20px !important;
        }
        input[type="date"], input[type="number"], input[type="time"] {
            min-width: 0 !important;
        }
        @media (max-width: 768px) {
            .p-4, .p-6 {
                padding: 8px !important;
            }
            .mb-4, .mb-6, .mb-8 {
                margin-bottom: 8px !important;
            }
        }
        
        /* Estilo para separar as colunas na escala semanal */
        #escalaSemanalOutput table {
            border-collapse: collapse !important;
        }
        #escalaSemanalOutput th, 
        #escalaSemanalOutput td {
            border: 2px solid #000000 !important;
            padding: 8px !important;
        }
        #escalaSemanalOutput th {
            background-color: #f1f5f9 !important;
            font-weight: bold !important;
        }
        #elemento-da-escala table, #elemento-da-escala td, #elemento-da-escala th {
  font-size: 10px;
  padding: 2px;
}
#escalaOutput table, #escalaOutput th, #escalaOutput td {
  width: auto;
  max-width: 100%;
  word-break: break-all;
  font-size: 10px;
  padding: 2px;
}
#escalaOutput table {
  table-layout: auto;
  width: 100%;
}
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-blue-100">
        <!-- Modal de Login -->
        <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded shadow-lg w-full max-w-md popup-content">
                <h3 class="text-xl font-semibold mb-4 text-center">Login do Sistema</h3>
                <form id="loginForm" onsubmit="return fazerLogin(event)">
                    <div class="mb-4">
                        <label class="block mb-1">Usuário:</label>
                        <input type="text" id="loginUsuario" class="p-2 border rounded w-full" required>
                    </div>
                    <div class="mb-4">
                        <label class="block mb-1">Senha:</label>
                        <input type="password" id="loginSenha" class="p-2 border rounded w-full" required>
                    </div>
                    <div id="loginErro" class="text-red-500 mb-4 hidden">Usuário ou senha incorretos!</div>
                    <div class="flex justify-center">
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Entrar</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="conteudoPrincipal" class="hidden">
            <div class="flex items-center justify-between mb-8 px-4">
            <img id="logoImg" src="" alt="Logo" class="bg-white rounded shadow mr-4 hidden" style="width:120px; height:64px; object-fit:contain;">
            <h1 class="text-4xl font-extrabold text-blue-700 text-center flex-1 drop-shadow">Sistema de Escala de Trabalho</h1>
            <div class="flex items-center">
                <button 
                    class="ml-4 p-2 rounded-full bg-blue-100 hover:bg-blue-300 transition shadow"
                    title="Configuração"
                    onclick="abrirPopupConfig()"
                >
                    <img src="engrenagem.png" alt="Configuração" class="h-7 w-7 object-contain" />
                </button>
                <button 
                    class="ml-4 p-2 rounded-full bg-red-100 hover:bg-red-300 transition shadow"
                    title="Sair"
                    onclick="fazerLogout()"
                >
                    <img src="logout.png" alt="Sair" class="h-7 w-7 object-contain" />
                </button>
            </div>
        </div>
        <div class="tabs flex justify-center mb-8">
            <button class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-l-lg hover:bg-blue-700 transition" onclick="showTab('gerenciar')">Gerenciar Funcionários</button>
            <button class="px-6 py-2 bg-blue-600 text-white font-semibold hover:bg-blue-700 transition" onclick="showTab('escala')">Visualizar Escala</button>
            <button class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-r-lg hover:bg-blue-700 transition" onclick="showTab('escalaSemanal')">Escala Semanal</button>
        </div>

        <!-- Aba Gerenciar Funcionários -->
        <div id="gerenciar" class="tab-content">
            
            <div class="flex flex-col md:flex-row gap-4 mb-4 bg-blue-50 p-4 rounded-lg shadow">
                <input id="filtroUnico" class="p-3 border border-blue-200 rounded-lg w-full focus:ring-2 focus:ring-blue-400 transition" placeholder="Buscar por crachá, nome, setor ou cargo" oninput="filtrarFuncionarios()">
                <button class="px-5 py-2 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 transition whitespace-nowrap" onclick="openPopup()">Cadastrar Funcionário</button>
            </div>
            <div class="overflow-x-auto rounded-lg shadow">
                <table class="w-full bg-white rounded-lg">
                    <thead>
                        <tr class="bg-blue-100 text-blue-900">
                            <th class="p-3">Crachá</th>
                            <th class="p-3">Nome</th>
                            <th class="p-3">Cargo</th>
                            <th class="p-3">Setor</th>
                            <th class="p-3">Admissão</th>
                            <th class="p-3">Férias</th>
                            <th class="p-3">Status das Férias</th>
                            <th class="p-3">Dias Vencido</th>
                            <th class="p-3">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="funcionariosTable" class="even:bg-blue-50 escala-visual-menor"></tbody>
                </table>
            </div>
            <!-- Controles de Paginação -->
            <div class="flex justify-between items-center mt-4 bg-white p-3 rounded-lg shadow">
                <div class="text-sm text-gray-600">
                    Mostrando <span id="paginaAtual">1</span> de <span id="totalPaginas">1</span> páginas
                </div>
                <div class="flex gap-2">
                    <button id="btnPaginaAnterior" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed" onclick="paginaAnterior()" disabled>Anterior</button>
                    <button id="btnProximaPagina" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed" onclick="proximaPagina()" disabled>Próxima</button>
                </div>
            </div>
        </div>

        <!-- Aba Visualizar Escala -->
        <div id="escala" class="tab-content hidden">
            
            <div class="bg-white p-4 rounded shadow mb-4 flex flex-col md:flex-row gap-4 items-end">
                <div class="flex-1">
                    <label class="block">Setor:</label>
                    <select id="setorEscala" class="w-full p-2 border rounded"></select>
                </div>
                <div class="flex-1">
                    <label class="block">Ano:</label>
                    <input type="number" id="anoEscala" class="w-full p-2 border rounded" value="2025" min="2000" max="2100">
                </div>
                <div class="flex-1">
                    <label class="block">Mês:</label>
                    <select id="mesEscala" class="w-full p-2 border rounded">
                        <option value="1">Janeiro</option>
                        <option value="2">Fevereiro</option>
                        <option value="3">Março</option>
                        <option value="4">Abril</option>
                        <option value="5">Maio</option>
                        <option value="6">Junho</option>
                        <option value="7">Julho</option>
                        <option value="8">Agosto</option>
                        <option value="9">Setembro</option>
                        <option value="10">Outubro</option>
                        <option value="11">Novembro</option>
                        <option value="12">Dezembro</option>
                    </select>
                </div>
                <button class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600" onclick="gerarEscala()">Gerar Escala</button>
                <button class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600" onclick="exportarPDF()">Exportar para PDF</button>
            </div>
            <div id="escalaOutput" class="bg-white p-4 rounded shadow"></div>
        </div>

        <!-- Aba Escala Semanal -->
        <div id="escalaSemanal" class="tab-content hidden">
            
            <div class="bg-white p-4 rounded shadow mb-4 flex flex-col md:flex-row gap-4 items-end">
                <div class="flex-1">
                    <label class="block">Setor:</label>
                    <select id="setorEscalaSemanal" class="w-full p-2 border rounded"></select>
                </div>
                <div class="flex-1">
                    <label class="block">Data de início da semana:</label>
                    <input type="date" id="dataInicioSemana" class="w-full p-2 border rounded">
                </div>
                <button class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600" onclick="gerarEscalaSemanal()">Gerar Escala Semanal</button>
                <button class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600" onclick="exportarPDFSemanal()">Exportar para PDF</button>
                <button id="btnEditarSemanal" class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600 ml-2" onclick="toggleEdicaoSemanal()">Editar Escala Semanal</button>
            </div>
            <div id="escalaSemanalOutput" class="bg-white p-4 rounded shadow"></div>
        </div>

        <!-- Pop-up para Configuração -->
        <div id="popupConfig" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-6 rounded shadow-lg w-full max-w-2xl popup-content" style="max-height: 80vh; overflow-y: auto;">
                <h3 class="text-xl font-semibold mb-4">Configuração</h3>
                
                <!-- Abas de configuração para melhor organização -->
                <div class="mb-4 border-b">
                    <div class="flex">
                        <button class="px-4 py-2 border-b-2 border-blue-500 text-blue-600 font-medium" onclick="mostrarAbaConfig('geral')">Geral</button>
                        <button class="px-4 py-2 border-b-2 border-transparent hover:text-blue-600" onclick="mostrarAbaConfig('usuarios')">Usuários</button>
                        <button class="px-4 py-2 border-b-2 border-transparent hover:text-blue-600" onclick="mostrarAbaConfig('permissoes')">Permissões</button>
                    </div>
                </div>
                
                <!-- Aba Geral -->
                <div id="configGeral" class="config-tab">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block mb-1">Primeiro dia da escala:</label>
                            <select id="primeiroDiaEscalaPopup" class="p-2 border rounded w-full">
                                <script>
                                    for(let i=1;i<=31;i++){
                                        document.write(`<option value="${i}">${i}</option>`);
                                    }
                                </script>
                            </select>
                        </div>
                        <div>
                            <label class="block mb-1">Imagem ao lado do título:</label>
                            <input type="file" id="logoInputPopup" accept="image/*" class="block w-full">
                            <small class="text-gray-500">Escolha uma imagem para aparecer ao lado do título.</small>
                        </div>
                        <div>
                            <label class="block mb-1">Largura da imagem (px):</label>
                            <input type="number" id="logoWidthPopup" min="32" max="512" value="120" class="p-2 border rounded w-full">
                            <label class="block mb-1 mt-2">Altura da imagem (px):</label>
                            <input type="number" id="logoHeightPopup" min="16" max="256" value="64" class="p-2 border rounded w-full">
                        </div>
                        <div class="md:col-span-3">
                            <label class="block mb-1 font-semibold">Backup dos Funcionários:</label>
                            <div class="flex gap-2">
                                <button class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600" onclick="fazerBackupFuncionarios()">Fazer Backup</button>
                                <input type="file" id="restoreInputPopup" accept=".json" class="block" onchange="restaurarBackupFuncionarios(event)">
                            </div>
                            <small class="text-gray-500">Faça download do backup ou selecione um arquivo para restaurar.</small>
                        </div>
                    </div>
                </div>
                
                <!-- Aba Usuários -->
                <div id="configUsuarios" class="config-tab hidden">
                    <h4 class="font-semibold mb-2">Gerenciamento de Usuários</h4>
                    <div class="overflow-x-auto rounded-lg shadow mb-4">
                        <table class="w-full bg-white rounded-lg">
                            <thead>
                                <tr class="bg-blue-100 text-blue-900">
                                    <th class="p-3">Usuário</th>
                                    <th class="p-3">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="usuariosTable"></tbody>
                        </table>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block mb-1">Novo Usuário:</label>
                            <input type="text" id="novoUsuario" class="p-2 border rounded w-full">
                        </div>
                        <div>
                            <label class="block mb-1">Nova Senha:</label>
                            <input type="password" id="novaSenha" class="p-2 border rounded w-full">
                        </div>
                    </div>
                    <button class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600" onclick="adicionarUsuario()">Adicionar Usuário</button>
                    
                    <div class="mt-4 pt-4 border-t">
                        <h4 class="font-semibold mb-2">Alterar Senha</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block mb-1">Senha Atual:</label>
                                <input type="password" id="senhaAtual" class="p-2 border rounded w-full">
                            </div>
                            <div>
                                <label class="block mb-1">Nova Senha:</label>
                                <input type="password" id="novaSenhaUsuario" class="p-2 border rounded w-full">
                            </div>
                        </div>
                        <button class="mt-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600" onclick="alterarSenha()">Alterar Senha</button>
                    </div>
                </div>
                
                <!-- Aba Permissões -->
                <div id="configPermissoes" class="config-tab hidden">
                    <h4 class="font-semibold mb-2">Permissões de Usuários</h4>
                    <div class="overflow-x-auto rounded-lg shadow mb-4">
                        <table class="w-full bg-white rounded-lg">
                            <thead>
                                <tr class="bg-blue-100 text-blue-900">
                                    <th class="p-3">Usuário</th>
                                    <th class="p-3">Adicionar Usuários</th>
                                    <th class="p-3">Adicionar Funcionários</th>
                                    <th class="p-3">Editar Funcionários</th>
                                </tr>
                            </thead>
                            <tbody id="permissoesTable"></tbody>
                        </table>
                    </div>
                    <small class="text-gray-500">Marque as caixas para conceder permissões aos usuários.</small>
                </div>
                
                <div class="mt-4 flex justify-end gap-2">
                    <button class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600" onclick="salvarConfiguracaoPopup()">Salvar</button>
                    <button class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600" onclick="fecharPopupConfig()">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- Pop-up para Cadastro/Edição -->
        <div id="popup" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-6 rounded shadow-lg w-full max-w-2xl popup-content">
                <h3 id="popupTitle" class="text-xl font-semibold mb-4">Cadastrar Funcionário</h3>
                <form id="funcionarioForm">
                    <input type="hidden" id="editId">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block">Crachá:</label>
                            <input type="text" id="cracha" class="w-full p-2 border rounded" required>
                        </div>
                        <div>
                            <label class="block">Nome:</label>
                            <input type="text" id="nome" class="w-full p-2 border rounded" required>
                        </div>
                        <div>
                            <label class="block">Função:</label>
                            <input type="text" id="funcao" class="w-full p-2 border rounded" required>
                        </div>
                        <div>
                            <label class="block">Setor:</label>
                            <input type="text" id="setor" class="w-full p-2 border rounded" required>
                        </div>
                        <div>
                            <label class="block">Admissão:</label>
                            <input type="date" id="admissao" class="w-full p-2 border rounded" required>
                        </div>
                        <div>
                            <label class="block">Primeira Folga Semanal:</label>
                            <input type="date" id="folgaSemanal" class="w-full p-2 border rounded" required>
                        </div>
                        <div>
                            <label class="block">Primeira Folga de Domingo:</label>
                            <input type="date" id="folgaDomingo" class="w-full p-2 border rounded" required>
                        </div>
                        <div>
                            <label class="block">Turno:</label>
                            <select id="turno" class="w-full p-2 border rounded" required>
                                <option value="Manhã">Manhã</option>
                                <option value="Tarde">Tarde</option>
                                <option value="Noite">Noite</option>
                            </select>
                        </div>
                        <div>
                            <label class="block">Data de Férias:</label>
                            <input type="date" id="ferias" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block">Dias de Férias:</label>
                            <input type="number" id="diasFerias" class="w-full p-2 border rounded" min="0">
                        </div>
                        <div>
                            <label class="block">Data de Afastamento:</label>
                            <input type="date" id="dataAfastamento" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block">Dias de Afastamento:</label>
                            <input type="number" id="diasAfastamento" class="w-full p-2 border rounded" min="0">
                        </div>
                        <div>
                            <label class="block">Data de Nascimento:</label>
                            <input type="date" id="nascimento" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block">Horário de Entrada:</label>
                            <input type="time" id="horaEntrada" class="w-full p-2 border rounded" required>
                        </div>
                        <div>
                            <label class="block">Horário de Saída:</label>
                            <input type="time" id="horaSaida" class="w-full p-2 border rounded" required>
                        </div>
                        <div>
                            <label class="block">Tipo de Escala:</label>
                            <select id="tipoEscala" class="w-full p-2 border rounded">
                                <option value="">Selecione</option>
                                <option value="6x1">6x1</option>
                                <option value="12x36">12x36</option>
                                <option value="5x2">5x2</option>
                                <option value="4x2">4x2</option>
                                <option value="4x3">4x3</option>
                                <option value="12x24">12x24</option>
                                <option value="6x2">6x2</option>
                                <option value="24x72">24x72</option>
                                <option value="3x3">3x3</option>
                                <option value="2x2">2x2</option>
                                <option value="5x1">5x1</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-4 flex justify-end gap-2">
                        <button type="submit" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">Salvar</button>
                        <button type="button" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600" onclick="closePopup()">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
        </div>

    <script>
        let db;
        moment.locale('pt-br');

        let modoEdicaoSemanal = false;
        let folgasManuais = {};
        let horariosPersonalizados = {};
        
        // Variáveis para controle de usuários e permissões
        let usuariosRegistrados = [];
        let permissoesUsuarios = [];
        let usuarioLogado = null;
        let primeiroDiaEscala = 21; // Valor padrão inicial
        
        // Variáveis para controle de paginação
        let paginaAtual = 1;
        let itensPorPagina = 10;
        let funcionariosFiltrados = [];

        // Carregar a imagem do logo ao iniciar a página
        window.addEventListener('DOMContentLoaded', function() {
            carregarLogoSalvo();
            initAuth();
        });

        // Função para carregar o logo salvo no localStorage
        function carregarLogoSalvo() {
            const configLogo = JSON.parse(localStorage.getItem('escala_config')) || {};
    const logoImg = configLogo.logoImg || '';
    const logoWidth = configLogo.logoWidth || 120;
    const logoHeight = configLogo.logoHeight || 64;

    const logo = document.getElementById('logoImg');
    if (logoImg) {
        logo.src = logoImg;
        logo.style.width = logoWidth + 'px';
        logo.style.height = logoHeight + 'px';
        logo.classList.remove('hidden');
    } else {
        logo.classList.add('hidden');
    }
        }

        function toggleEdicaoSemanal() {
            if (modoEdicaoSemanal) {
                // Se estiver saindo do modo de edição, salvar as alterações
                localStorage.setItem('folgasManuais', JSON.stringify(folgasManuais));
                localStorage.setItem('horariosPersonalizados', JSON.stringify(horariosPersonalizados));
            }
            
            modoEdicaoSemanal = !modoEdicaoSemanal;
            const btnEditarSemanal = document.getElementById('btnEditarSemanal');
            btnEditarSemanal.textContent = modoEdicaoSemanal ? 'Salvar Alterações' : 'Editar Escala Semanal';
            btnEditarSemanal.classList.toggle('bg-green-500');
            btnEditarSemanal.classList.toggle('bg-yellow-500');
            
            carregarFolgasManuais();
            carregarHorariosPersonalizados();
            gerarEscalaSemanal(modoEdicaoSemanal, folgasManuais);
        }

        function carregarFolgasManuais() {
            const data = localStorage.getItem('folgasManuais');
            if (data) {
                try {
                    folgasManuais = JSON.parse(data);
                } catch (e) {
                    console.error('Erro ao carregar folgas manuais:', e);
                    folgasManuais = {};
                }
            } else {
                folgasManuais = {};
            }
        }

        function salvarFolgasManuais() {
            localStorage.setItem('folgasManuais', JSON.stringify(folgasManuais));
        }

        function carregarHorariosPersonalizados() {
            const data = localStorage.getItem('horariosPersonalizados');
            horariosPersonalizados = data ? JSON.parse(data) : {};
        }

        function salvarHorariosPersonalizados() {
            localStorage.setItem('horariosPersonalizados', JSON.stringify(horariosPersonalizados));
        }

        function alterarHorario(dia, nome) {
            // Buscar o horário atual
            const horarioAtual = horariosPersonalizados[dia]?.[nome] || 
                db.exec(`SELECT horaEntrada FROM funcionarios WHERE nome = ?`, [nome])[0]?.values[0]?.[0];
    
            // Abrir prompt para edição
            const novoHorario = prompt('Digite o novo horário (HH:MM):', horarioAtual);
    
            // Validar e salvar o novo horário
            if (novoHorario && /^([01]?[0-9]|2[0-3]):[0-5][0-9]$/.test(novoHorario)) {
                if (!horariosPersonalizados[dia]) {
                    horariosPersonalizados[dia] = {};
                }
                horariosPersonalizados[dia][nome] = novoHorario;
                salvarHorariosPersonalizados();
                gerarEscalaSemanal(true, folgasManuais);
            } else if (novoHorario !== null) {
                alert('Formato de horário inválido. Use HH:MM');
            }
        }

        function marcarFolgaManual(checkbox) {
            const dia = checkbox.getAttribute('data-dia');
            const nome = checkbox.getAttribute('data-nome');
            
            if (!folgasManuais[dia]) {
                folgasManuais[dia] = {};
            }
            
            if (checkbox.checked) {
                // Quando marcar a folga, mostrar opções de tipo de folga
                const tipoFolga = prompt('Selecione o tipo de folga:\n1 - FF\n2 - FOLGA\n3 - TREINAMENTO', '1');
                
                if (tipoFolga === '1') {
                    folgasManuais[dia][nome] = 'FF';
                } else if (tipoFolga === '2') {
                    folgasManuais[dia][nome] = 'FOLGA';
                } else if (tipoFolga === '3') {
                    folgasManuais[dia][nome] = 'TREINAMENTO';
                } else {
                    // Se cancelou ou entrada inválida, usar FF como padrão
                    folgasManuais[dia][nome] = 'FF';
                }
            } else {
                // Remover a folga
                delete folgasManuais[dia][nome];
                
                // Se não houver mais folgas neste dia, remover o dia
                if (Object.keys(folgasManuais[dia]).length === 0) {
                    delete folgasManuais[dia];
                }
            }
            
            localStorage.setItem('folgasManuais', JSON.stringify(folgasManuais));
            
            // Atualizar a visualização
            gerarEscalaSemanal(true, folgasManuais);
        }

        function salvarFolgasManuais() {
            localStorage.setItem('folgasManuais', JSON.stringify(folgasManuais));
        }

        function carregarFolgasManuais() {
            const data = localStorage.getItem('folgasManuais');
            folgasManuais = data ? JSON.parse(data) : {};
        }

        // Função para determinar o turno
function obterTurno(horarioEntrada) {
    if (!horarioEntrada) return '';
    const hora = parseInt(horarioEntrada.split(':')[0]);
    if (hora >= 5 && hora < 13) return 'Manhã';
    if (hora >= 13 && hora < 19) return 'Tarde';
    return 'Noite';
}

// Inicializar SQL.js
        async function initDb() {
            const SQL = await initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}` });
            const savedDb = localStorage.getItem('escala_db');
            db = savedDb ? new SQL.Database(new Uint8Array(JSON.parse(savedDb))) : new SQL.Database();
            db.run(`
                CREATE TABLE IF NOT EXISTS funcionarios (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    cracha TEXT,
                    nome TEXT,
                    funcao TEXT,
                    setor TEXT,
                    admissao TEXT,
                    folgaSemanal TEXT,
                    folgaDomingo TEXT,
                    turno TEXT,
                    ferias TEXT,
                    diasFerias INTEGER,
                    nascimento TEXT,
                    horaEntrada TEXT,
                    horaSaida TEXT,
                    tipoEscala TEXT,
                    dataAfastamento TEXT,
                    diasAfastamento INTEGER
                );
            `);
            try {
                db.run("ALTER TABLE funcionarios ADD COLUMN horaEntrada TEXT");
            } catch (e) {}
            try {
                db.run("ALTER TABLE funcionarios ADD COLUMN horaSaida TEXT");
            } catch (e) {}
            try {
                db.run("ALTER TABLE funcionarios ADD COLUMN tipoEscala TEXT");
            } catch (e) {}
            loadFuncionarios();
            loadSetores();
            loadSetoresSemanal();
        }

        // Salvar banco no localStorage
        function saveDb() {
            const data = db.export();
            localStorage.setItem('escala_db', JSON.stringify(Array.from(data)));
        }

        // Carregar funcionários na tabela
        function loadFuncionarios() {
            const result = db.exec("SELECT * FROM funcionarios");
            if (result[0]) {
                funcionariosFiltrados = result[0].values;
                // Atualizar paginação e exibir resultados
                paginaAtual = 1;
                atualizarPaginacao();
            } else {
                funcionariosFiltrados = [];
                document.getElementById('funcionariosTable').innerHTML = '';
            }
            loadSetores();
            loadSetoresSemanal();
        }
        
        // Função para renderizar funcionários na tabela
        function renderizarFuncionarios(funcionarios) {
            const tbody = document.getElementById('funcionariosTable');
            tbody.innerHTML = '';
            
            funcionarios.forEach(row => {
                // Dados
                const cracha = row[1];
                const nome = row[2];
                const cargo = row[3];
                const setor = row[4];
                const admissao = row[5] ? moment(row[5]).format('DD/MM/YYYY') : '';
                const ferias = row[9] ? moment(row[9]).format('DD/MM/YYYY') : '';
                const diasFerias = row[10] || 0;

                // Status das férias
                let statusFerias = 'Sem férias';
                let tempoVencido = '-';
                if (row[9]) {
                    const dataFerias = moment(row[9]);
                    const hoje = moment();
                    const anoAtual = hoje.year();
                    const anoFerias = dataFerias.year();
                    if (hoje.isBefore(dataFerias)) {
                        statusFerias = 'Agendada';
                        tempoVencido = '-';
                    } else if (hoje.isBetween(dataFerias, dataFerias.clone().add(diasFerias, 'days'), null, '[]')) {
                        statusFerias = 'Em férias';
                        tempoVencido = '-';
                    } else if (anoFerias === anoAtual) {
                        statusFerias = 'Em dia';
                        tempoVencido = '-';
                    } else {
                        statusFerias = 'Vencida';
                        // Tempo vencido em dias
                        const vencidoDias = hoje.diff(dataFerias.clone().add(diasFerias, 'days'), 'days');
                        tempoVencido = vencidoDias > 0 ? `${vencidoDias} dia(s)` : '-';
                    }
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-2">${cracha}</td>
                    <td class="p-2">${nome}</td>
                    <td class="p-2">${cargo}</td>
                    <td class="p-2">${setor}</td>
                    <td class="p-2">${admissao}</td>
                    <td class="p-2">${ferias}${diasFerias ? ` (${diasFerias} dias)` : ''}</td>
                    <td class="p-2">${statusFerias}</td>
                    <td class="p-2">${tempoVencido}</td>
                    <td class="p-2 flex gap-2">
                        <button class="p-1 rounded hover:bg-yellow-100 transition" title="Editar" onclick="editFuncionario(${row[0]})">
                            <img src="editar.png" alt="Editar" class="h-6 w-6 object-contain" />
                        </button>
                        <button class="p-1 rounded hover:bg-red-100 transition" title="Excluir" onclick="deleteFuncionario(${row[0]})">
                            <img src="excluir.png" alt="Excluir" class="h-6 w-6 object-contain" />
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Filtrar funcionários
        function filtrarFuncionarios() {
            const termo = document.getElementById('filtroUnico').value.toLowerCase();
            const result = db.exec("SELECT * FROM funcionarios");
            
            if (result[0]) {
                // row[1]=cracha, row[2]=nome, row[3]=cargo, row[4]=setor
                funcionariosFiltrados = result[0].values.filter(row => 
                    !termo ||
                    row[1].toLowerCase().includes(termo) ||
                    row[2].toLowerCase().includes(termo) ||
                    row[3].toLowerCase().includes(termo) ||
                    row[4].toLowerCase().includes(termo)
                );
                
                // Resetar para a primeira página ao filtrar
                paginaAtual = 1;
                
                // Atualizar paginação e exibir resultados
                atualizarPaginacao();
            } else {
                funcionariosFiltrados = [];
                document.getElementById('funcionariosTable').innerHTML = '';
            }
        }

        // Carregar setores no select da escala
        function loadSetores() {
            const result = db.exec("SELECT DISTINCT setor FROM funcionarios");
            const select = document.getElementById('setorEscala');
            select.innerHTML = '<option value="">Todos</option>';
            if (result[0]) {
                result[0].values.forEach(row => {
                    select.innerHTML += `<option value="${row[0]}">${row[0]}</option>`;
                });
            }
        }

        // Carregar setores no select da escala semanal
        function loadSetoresSemanal() {
            const result = db.exec("SELECT DISTINCT setor FROM funcionarios");
            const selectSemanal = document.getElementById('setorEscalaSemanal');
            if (selectSemanal) {
                selectSemanal.innerHTML = '<option value="">Todos</option>';
                if (result[0]) {
                    result[0].values.forEach(row => {
                        selectSemanal.innerHTML += `<option value="${row[0]}">${row[0]}</option>`;
                    });
                }
            }
        }

        // Abrir pop-up
        function openPopup(isEdit = false) {
            if (!isEdit && !temPermissao('adicionarFuncionarios')) {
                alert('Você não tem permissão para adicionar funcionários!');
                return;
            }
            
            const popup = document.getElementById('popup');
            const title = document.getElementById('popupTitle');
            title.textContent = isEdit ? 'Editar Funcionário' : 'Cadastrar Funcionário';
            if (!isEdit) {
                resetForm();
            }
            popup.classList.remove('hidden');
        }

        // Fechar pop-up
        function closePopup() {
            document.getElementById('popup').classList.add('hidden');
            resetForm();
        }

        // Salvar/editar funcionário
        document.getElementById('funcionarioForm').addEventListener('submit', e => {
            e.preventDefault();
            console.log('submit!');
            const id = document.getElementById('editId').value;
            const data = {
                cracha: document.getElementById('cracha').value,
                nome: document.getElementById('nome').value,
                funcao: document.getElementById('funcao').value,
                setor: document.getElementById('setor').value,
                admissao: document.getElementById('admissao').value,
                folgaSemanal: document.getElementById('folgaSemanal').value,
                folgaDomingo: document.getElementById('folgaDomingo').value,
                turno: document.getElementById('turno').value,
                ferias: document.getElementById('ferias').value || null,
                diasFerias: document.getElementById('diasFerias').value || null,
                nascimento: document.getElementById('nascimento').value,
                horaEntrada: document.getElementById('horaEntrada').value,
                horaSaida: document.getElementById('horaSaida').value,
                tipoEscala: document.getElementById('tipoEscala').value,
                dataAfastamento: document.getElementById('dataAfastamento').value || null,
                diasAfastamento: document.getElementById('diasAfastamento').value || null
            };

            console.log([
                data.cracha, data.nome, data.funcao, data.setor, data.admissao,
                data.folgaSemanal, data.folgaDomingo, data.turno, data.ferias,
                data.diasFerias, data.nascimento, data.horaEntrada, data.horaSaida, data.tipoEscala, id
            ]);

            if (moment(data.folgaDomingo).day() !== 0) {
                alert('A primeira folga de domingo deve ser um domingo!');
                return;
            }

            if (id) {
                db.run(`
                    UPDATE funcionarios SET
                        cracha = ?, nome = ?, funcao = ?, setor = ?, admissao = ?,
                        folgaSemanal = ?, folgaDomingo = ?, turno = ?, ferias = ?,
                        diasFerias = ?, nascimento = ?, horaEntrada = ?, horaSaida = ?, tipoEscala = ?,
                        dataAfastamento = ?, diasAfastamento = ?
                    WHERE id = ?
                `, [
                    data.cracha, data.nome, data.funcao, data.setor, data.admissao,
                    data.folgaSemanal, data.folgaDomingo, data.turno, data.ferias,
                    data.diasFerias, data.nascimento, data.horaEntrada, data.horaSaida, data.tipoEscala,
                    data.dataAfastamento, data.diasAfastamento, id
                ]);
            } else {
                db.run(`
                    INSERT INTO funcionarios (
                        cracha, nome, funcao, setor, admissao, folgaSemanal,
                        folgaDomingo, turno, ferias, diasFerias, nascimento,
                        horaEntrada, horaSaida, tipoEscala, dataAfastamento, diasAfastamento
                    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                `, [
                    data.cracha, data.nome, data.funcao, data.setor, data.admissao,
                    data.folgaSemanal, data.folgaDomingo, data.turno, data.ferias,
                    data.diasFerias, data.nascimento, data.horaEntrada, data.horaSaida, data.tipoEscala,
                    data.dataAfastamento, data.diasAfastamento
                ]);
            }
            saveDb();
            loadFuncionarios();
            loadSetores();
            loadSetoresSemanal();
            closePopup();
        });

        // Editar funcionário
        function editFuncionario(id) {
            if (!temPermissao('editarFuncionarios')) {
                alert('Você não tem permissão para editar funcionários!');
                return;
            }
            
            const result = db.exec("SELECT * FROM funcionarios WHERE id = ?;", [id]);
            if (result[0] && result[0].values.length > 0) {
                const row = result[0].values[0];
                document.getElementById('editId').value = row[0];
                document.getElementById('cracha').value = row[1] || '';
                document.getElementById('nome').value = row[2] || '';
                document.getElementById('funcao').value = row[3] || '';
                document.getElementById('setor').value = row[4] || '';
                document.getElementById('admissao').value = row[5] || '';
                document.getElementById('folgaSemanal').value = row[6] || '';
                document.getElementById('folgaDomingo').value = row[7] || '';
                document.getElementById('turno').value = row[8] || 'Manhã';
                document.getElementById('ferias').value = row[9] || '';
                document.getElementById('diasFerias').value = row[10] || '';
                document.getElementById('nascimento').value = row[11] || '';
                document.getElementById('horaEntrada').value = row[12] || '';
                document.getElementById('horaSaida').value = row[13] || '';
                document.getElementById('tipoEscala').value = row[14] || '';
                document.getElementById('dataAfastamento').value = row[16] || '';
                document.getElementById('diasAfastamento').value = row[17] || '';
                openPopup(true);
            } else {
                alert('Funcionário não encontrado.');
            }
        }

        // Excluir funcionário
        function deleteFuncionario(id) {
            if (confirm('Tem certeza que deseja excluir este funcionário?')) {
                db.run("DELETE FROM funcionarios WHERE id = ?;", [id]);
                saveDb();
                loadFuncionarios();
                loadSetores();
                loadSetoresSemanal();
            }
        }

        // Limpar formulário
        function resetForm() {
            document.getElementById('funcionarioForm').reset();
            document.getElementById('editId').value = '';
        }

        // Gerar escala
        function gerarEscala() {
            const setor = document.getElementById('setorEscala').value;
            const ano = parseInt(document.getElementById('anoEscala').value);
            const mes = parseInt(document.getElementById('mesEscala').value);
            const output = document.getElementById('escalaOutput');
            output.innerHTML = '';

            // Defina as datas ANTES de usar!
            const startDate = moment([ano, mes - 1, primeiroDiaEscala]);
            const endDate = startDate.clone().add(1, 'month').subtract(1, 'day');
            const totalDias = endDate.diff(startDate, 'days') + 1;

            // Recupera logo e configurações
            const configLogo = JSON.parse(localStorage.getItem('escala_config')) || {};
            const logoImg = configLogo.logoImg || '';
            const logoWidth = configLogo.logoWidth || 120;
            const logoHeight = configLogo.logoHeight || 64;

            // Setor selecionado
            const setorSelecionado = setor || 'Todos';

            // Período da escala
            const periodoEscala = `${startDate.format('DD [de] MMMM')} a ${endDate.format('DD [de] MMMM [de] YYYY')}`;

            // Topo da escala
            let topoEscala = `
                <div class="flex flex-col items-center mb-2">
                    <div class="flex items-center justify-center w-full mb-1">
                        ${logoImg ? `<img src="${logoImg}" alt="Logo" style="width:${logoWidth}px;height:${logoHeight}px;object-fit:contain;" class="bg-white rounded shadow mr-4">` : ''}
                        <span class="font-bold flex-1 text-center" style="font-size:14px !important">${setorSelecionado}</span>
                    </div>
                    <div class="text-base font-semibold text-center w-full">${periodoEscala}</div>
                </div>
            `;

            // Buscar funcionários do setor selecionado (ou todos)
            let query = "SELECT * FROM funcionarios";
            let params = [];
            if (setorSelecionado !== 'Todos' && setorSelecionado !== '') {
                query += " WHERE setor = ?";
                params.push(setorSelecionado);
            }
            const result = db.exec(query, params);

            // Filtrar feriados do período
            const feriadosTodos = getFeriados(ano);
            const endAno = endDate.year();
            if (endAno !== ano) {
                feriadosTodos.push(...getFeriados(endAno));
            }
            const feriados = feriadosTodos.filter(f =>
                f.data.isSameOrAfter(startDate, 'day') && f.data.isSameOrBefore(endDate, 'day')
            );

            // Filtrar aniversariantes do período
            const aniversariantes = [];
            if (result[0]) {
                result[0].values.forEach(row => {
                    const nome = row[2];
                    const nascimento = moment(row[11]);
                    if (!nascimento.isValid()) return;
                    let aniversario = nascimento.clone().year(startDate.year());
                    if (aniversario.isBefore(startDate, 'day')) {
                        aniversario = aniversario.clone().add(1, 'year');
                    }
                    if (aniversario.isSameOrAfter(startDate, 'day') && aniversario.isSameOrBefore(endDate, 'day')) {
                        aniversariantes.push({ nome, dia: aniversario.format('DD/MM') });
                    }
                });
            }

            // Montar bloco de feriados e aniversariantes
            let infoExtra = `
                <div class="mt-4 escala-visual-menor">
                    <h2 class="text-lg font-semibold mb-1">Feriados</h2>
                    <ul class="mb-2">
                        ${feriados.length === 0 ? '<li>Nenhum feriado no período.</li>' : feriados.map(f => `<li>${f.data.format('DD/MM/YYYY')} - ${f.nome}</li>`).join('')}
                    </ul>
                    <h2 class="text-lg font-semibold mb-1">Aniversariantes</h2>
                    <ul>
                        ${aniversariantes.length === 0 ? '<li>Nenhum aniversariante no período.</li>' : aniversariantes.sort((a, b) => a.dia.localeCompare(b.dia)).map(a => `<li>${a.dia} - ${a.nome}</li>`).join('')}
                    </ul>
                </div>
            `;

            // Cabeçalho da tabela
            let table = `
                <table class="w-full border border-gray-300 border-collapse">
                    <thead>
                        <tr class="bg-gray-200">
                            <th class="p-2 border border-gray-300">Crachá</th>
                            <th class="p-2 border border-gray-300">Nome</th>
                            <th class="p-2 border border-gray-300">Cargo</th>
                            <th class="p-2 border border-gray-300" colspan="2">Turno</th>`;
            for (let i = 0; i < totalDias; i++) {
                const dia = startDate.clone().add(i, 'days');
                table += `<th class="p-2 border border-gray-300" style="width:30px;">${dia.date()}</th>`;
            }
            table += `</tr>`;

            table += `<tr class="bg-gray-100">
                <th class="p-2 border border-gray-300"></th>
                <th class="p-2 border border-gray-300"></th>
                <th class="p-2 border border-gray-300"></th>
                <th class="p-2 border border-gray-300" colspan="2"></th>`;
            for (let i = 0; i < totalDias; i++) {
                const dia = startDate.clone().add(i, 'days');
                const diasSemana = {
                    'seg': 'S',
                    'ter': 'T',
                    'qua': 'Q',
                    'qui': 'Q',
                    'sex': 'S',
                    'sáb': 'S',
                    'dom': 'D'
                };
                const dayOfWeek = dia.format('ddd').toLowerCase();
                table += `<th class="p-1 text-xs border border-gray-300" style="width:30px;">${diasSemana[dayOfWeek] || dayOfWeek}</th>`;
            }
            table += `</tr>
            </thead>
            <tbody>
            `;

            // Montar linhas dos funcionários
            if (result[0]) {
                // Ordena por turno: Manhã, Tarde, Noite
                const ordemTurno = { 'Manhã': 1, 'Tarde': 2, 'Noite': 3 };
                const funcionariosOrdenados = result[0].values.slice().sort((a, b) => {
                    const turnoA = a[8] || '';
                    const turnoB = b[8] || '';
                    return (ordemTurno[turnoA] || 99) - (ordemTurno[turnoB] || 99);
                });

                funcionariosOrdenados.forEach(row => {
                    const cracha = row[1];
                    const nome = row[2];
                    const cargo = row[3];
                    const turno = row[8] || '';
                    const folgaSemanal = moment(row[6]);
                    const folgaDomingo = moment(row[7]);
                    const ferias = row[9] ? moment(row[9]) : null;
                    const diasFerias = row[10] || 0;
                    const tipoEscala = row[14] || '';

                    table += `<tr>
                        <td class="p-2 whitespace-nowrap border border-gray-300">${cracha}</td>
                        <td class="p-2 whitespace-nowrap border border-gray-300">${nome}</td>
                        <td class="p-2 whitespace-nowrap border border-gray-300">${cargo}</td>
                        <td class="p-2 whitespace-nowrap border border-gray-300" colspan="2">${turno}</td>`;

                    for (let i = 0; i < totalDias; i++) {
                        const currentDate = startDate.clone().add(i, 'days');
                        let status = '';
                        let bgClass = '';

    // Verifique se está de férias
    const emFerias = ferias && currentDate.isBetween(ferias, ferias.clone().add(diasFerias, 'days'), null, '[]');
    // Verifique se está afastado
    const dataAfastamento = row[16] ? moment(row[16]) : null;
    const diasAfastamento = row[17] || 0;
    const emAfastamento = dataAfastamento && currentDate.isBetween(dataAfastamento, dataAfastamento.clone().add(diasAfastamento, 'days'), null, '[]');
    // Verifique se é feriado
    const ehFeriado = getFeriados(currentDate.year()).some(f => f.data.isSame(currentDate, 'day'));
    // Verifique se é domingo
    const ehDomingo = currentDate.day() === 0;

    // Lógica de folga baseada no tipo de escala
    let ehFolga = false;
    let ehFolgaDomingo = false;
    if (tipoEscala === '6x1' && folgaSemanal && folgaSemanal.isValid()) {
        // Folga semanal normal
        if (currentDate.day() === folgaSemanal.day() && currentDate.diff(folgaSemanal, 'days') % 7 === 0) {
            ehFolga = true;
        }
        // Folga de domingo a cada 3 domingos, a partir da primeira folga de domingo
        if (ehDomingo && folgaDomingo && folgaDomingo.isValid() && currentDate.isSameOrAfter(folgaDomingo, 'day')) {
            const domingosDesdeFolga = Math.floor(currentDate.diff(folgaDomingo, 'days') / 7);
            if (domingosDesdeFolga % 3 === 0) {
                ehFolgaDomingo = true;
            }
        }
    } else if (tipoEscala && folgaSemanal && folgaSemanal.isValid()) {
        const diasDesdeInicio = currentDate.diff(folgaSemanal, 'days');
        switch(tipoEscala) {
            case '5x2':
                if (diasDesdeInicio % 7 === 0 || diasDesdeInicio % 7 === 6) ehFolga = true;
                break;
            case '4x2':
                if (diasDesdeInicio % 6 === 0 || diasDesdeInicio % 6 === 5) ehFolga = true;
                break;
            case '4x3':
                if ([0,5,6].includes(diasDesdeInicio % 7)) ehFolga = true;
                break;
            case '12x36':
            case '12x24':
                if (diasDesdeInicio % 2 === 0) ehFolga = true;
                break;
            case '6x2':
                if (diasDesdeInicio % 8 === 0 || diasDesdeInicio % 8 === 7) ehFolga = true;
                break;
            case '24x72':
                if ([0,1,2].includes(diasDesdeInicio % 4)) ehFolga = true;
                break;
            case '3x3':
                if ((diasDesdeInicio % 6) >= 3) ehFolga = true;
                break;
            case '2x2':
                if ((diasDesdeInicio % 4) >= 2) ehFolga = true;
                break;
            case '5x1':
                if (diasDesdeInicio % 6 === 0) ehFolga = true;
                break;
            default:
                if (diasDesdeInicio % 7 === 0) ehFolga = true;
        }
    } else if (folgaSemanal && folgaSemanal.isValid()) {
        if (currentDate.day() === folgaSemanal.day() && currentDate.diff(folgaSemanal, 'days') % 7 === 0) ehFolga = true;
    }

    if (emAfastamento) {
        bgClass = 'bg-red-900 text-white';
        status = '';
    } else if (emFerias) {
        bgClass = 'bg-gray-700 text-white';
        status = '';
    } else if (ehFolgaDomingo) {
        bgClass = 'bg-green-300';
        status = 'F';
    } else if (ehFolga) {
        bgClass = 'bg-green-300';
        status = 'F';
    } else if (ehDomingo) {
        bgClass = 'bg-red-200';
        status = '';
    } else if (ehFeriado) {
        bgClass = 'bg-orange-200';
        status = '';
    } else {
        bgClass = '';
        status = '';
    }

    table += `<td class="p-2 text-center border border-gray-300 ${bgClass}" style="width:30px;">${status}</td>`;
                    }

                    table += `</tr>`;
                });
            } else {
                table += `<tr><td colspan="${5 + totalDias}" class="p-2 text-center border border-gray-300">Nenhum funcionário encontrado.</td></tr>`;
            }

            table += `</tbody></table>`;

            // Exibe o topo, a tabela e as informações extras
            output.innerHTML = `
                ${topoEscala}
                <div class="w-full overflow-x-auto escala-visual-menor">
                    ${table}
                </div>
                ${infoExtra}
            `;
        }

        // Função para calcular feriados
        function getFeriados(ano) {
            // Função para calcular a Páscoa (algoritmo de Meeus/Jones/Butcher)
            function calcPascoa(y) {
                const a = y % 19;
                const b = Math.floor(y / 100);
                const c = y % 100;
                const d = Math.floor(b / 4);
                const e = b % 4;
                const f = Math.floor((b + 8) / 25);
                const g = Math.floor((b - f + 1) / 3);
                const h = (19 * a + b - d - g + 15) % 30;
                const i = Math.floor(c / 4);
                const k = c % 4;
                const l = (32 + 2 * e + 2 * i - h - k) % 7;
                const m = Math.floor((a + 11 * h + 22 * l) / 451);
                const mes = Math.floor((h + l - 7 * m + 114) / 31);
                const dia = ((h + l - 7 * m + 114) % 31) + 1;
                return moment(`${y}-${mes}-${dia}`, "YYYY-M-D");
            }

            const pascoa = calcPascoa(ano);
            const sextaSanta = pascoa.clone().subtract(2, 'days');
            const corpusChristi = pascoa.clone().add(60, 'days');

            return [
                { data: moment(`${ano}-01-01`), nome: 'Confraternização Universal' },
                { data: sextaSanta, nome: 'Sexta-feira Santa' },
                { data: moment(`${ano}-04-21`), nome: 'Tiradentes' },
                { data: moment(`${ano}-05-01`), nome: 'Dia do Trabalho' },
                { data: corpusChristi, nome: 'Corpus Christi' },
                { data: moment(`${ano}-07-09`), nome: 'Revolução Constitucionalista de 1932' },
                { data: moment(`${ano}-08-15`), nome: 'Aniversário de Sorocaba' },
                { data: moment(`${ano}-09-07`), nome: 'Independência do Brasil' },
                { data: moment(`${ano}-10-12`), nome: 'Nossa Senhora Aparecida' },
                { data: moment(`${ano}-11-02`), nome: 'Finados' },
                { data: moment(`${ano}-11-15`), nome: 'Proclamação da República' },
                { data: moment(`${ano}-11-20`), nome: 'Consciência Negra' },
                { data: moment(`${ano}-12-25`), nome: 'Natal' }
            ];
        }

        // Fazer backup dos funcionários
        function fazerBackupFuncionarios() {
            const result = db.exec("SELECT * FROM funcionarios");
            if (!result[0]) {
                alert("Nenhum funcionário para exportar.");
                return;
            }
            const colunas = result[0].columns;
            const funcionarios = result[0].values.map(row => {
                const obj = {};
                colunas.forEach((col, idx) => obj[col] = row[idx]);
                return obj;
            });
            const blob = new Blob([JSON.stringify(funcionarios, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "backup_funcionarios.json";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Restaurar backup dos funcionários
        function restaurarBackupFuncionarios(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const funcionarios = JSON.parse(e.target.result);
                    if (!Array.isArray(funcionarios)) throw new Error("Arquivo inválido.");
                    // Limpa a tabela antes de importar
                    db.run("DELETE FROM funcionarios");
                    funcionarios.forEach(f => {
                        db.run(`
                            INSERT INTO funcionarios (
                                id, cracha, nome, funcao, setor, admissao, folgaSemanal,
                                folgaDomingo, turno, ferias, diasFerias, nascimento,
                                horaEntrada, horaSaida, tipoEscala, dataAfastamento, diasAfastamento
                            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                        `, [
                            f.id, f.cracha, f.nome, f.funcao, f.setor, f.admissao, f.folgaSemanal,
                            f.folgaDomingo, f.turno, f.ferias, f.diasFerias, f.nascimento,
                            f.horaEntrada, f.horaSaida, f.tipoEscala || '', f.dataAfastamento || null, f.diasAfastamento || null
                        ]);
                    });
                    saveDb();
                    loadFuncionarios();
                    loadSetores();
                    loadSetoresSemanal();
                    alert("Backup restaurado com sucesso!");
                } catch (err) {
                    alert("Erro ao restaurar backup: " + err.message);
                }
                // Limpa o input para permitir restaurar novamente se necessário
                event.target.value = "";
            };
            reader.readAsText(file);
        }

        // Carregar configuração ao iniciar
        function carregarConfiguracao() {
            const config = JSON.parse(localStorage.getItem('escala_config')) || {};
            // Corrija os IDs aqui:
            if (document.getElementById('primeiroDiaEscalaPopup')) {
                document.getElementById('primeiroDiaEscalaPopup').value = config.primeiroDia || 1;
            }
            if (document.getElementById('logoWidthPopup')) {
                document.getElementById('logoWidthPopup').value = config.logoWidth || 120;
            }
            if (document.getElementById('logoHeightPopup')) {
                document.getElementById('logoHeightPopup').value = config.logoHeight || 64;
            }
            if (config.logoImg) {
                mostrarLogo(config.logoImg, config.logoWidth, config.logoHeight);
            } else {
                mostrarLogo('', config.logoWidth, config.logoHeight);
            }
        }

        // Salvar configuração
        function salvarConfiguracao() {
            const primeiroDia = parseInt(document.getElementById('primeiroDiaEscala').value);
            const logoInput = document.getElementById('logoInput');
            const logoWidth = parseInt(document.getElementById('logoWidth').value) || 120;
            const logoHeight = parseInt(document.getElementById('logoHeight').value) || 64;
            let config = { primeiroDia, logoWidth, logoHeight };

            if (logoInput.files && logoInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    config.logoImg = e.target.result;
                    localStorage.setItem('escala_config', JSON.stringify(config));
                    mostrarLogo(config.logoImg, config.logoWidth, config.logoHeight);
                    alert('Configuração salva!');
                };
                reader.readAsDataURL(logoInput.files[0]);
            } else {
                const oldConfig = JSON.parse(localStorage.getItem('escala_config')) || {};
                if (oldConfig.logoImg) config.logoImg = oldConfig.logoImg;
                localStorage.setItem('escala_config', JSON.stringify(config));
                mostrarLogo(config.logoImg, config.logoWidth, config.logoHeight);
                alert('Configuração salva!');
            }
        }

        // Exibir logo ao lado do título
        function mostrarLogo(src, width, height) {
            const logoImg = document.getElementById('logoImg');
            if (src) {
                logoImg.src = src;
                logoImg.classList.remove('hidden');
            } else {
                logoImg.classList.add('hidden');
            }
            logoImg.style.width = (width || 120) + 'px';
            logoImg.style.height = (height || 64) + 'px';
        }

        // Alternar abas
        function showTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(tab).classList.remove('hidden');
        }

        // Exportar escala para PDF
        function exportarPDF() {
            const element = document.getElementById('escalaOutput');
            const tabelaDiv = element.querySelector('.escala-visual-menor');
            let removeClasse = false;
            if (tabelaDiv && tabelaDiv.classList.contains('escala-visual-menor')) {
                tabelaDiv.classList.remove('escala-visual-menor');
                removeClasse = true;
            }

            // Salva e ajusta temporariamente o tamanho da fonte
            const originalFontSize = element.style.fontSize;
            // Não altere o tamanho da fonte!
            element.style.fontSize = '22px'; // Ou maior, se desejar

            const tds = element.querySelectorAll('td, th');
            const originalPaddings = [];
            tds.forEach(td => {
                originalPaddings.push(td.style.padding);
                td.style.padding = '2px'; // padding ainda mais compacto
            });

            // --- ALTERAÇÃO AQUI ---
            // Força a largura máxima para caber toda a tabela
            const originalMaxWidth = element.style.maxWidth;
            const originalWidth = element.style.width;
            element.style.maxWidth = 'none';
            element.style.width = element.scrollWidth + 'px';
            // ----------------------

            const opt = {
                margin:       [0, 0, 0, 0],
                filename:     'escala.pdf',
                image:        { type: 'jpeg', quality: 1 },
                html2canvas:  { scale: 2, useCORS: true, width: element.scrollWidth },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'landscape' },
                pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                // --- RESTAURAÇÃO ---
                element.style.maxWidth = originalMaxWidth;
                element.style.width = originalWidth;
                // -------------------
                tds.forEach((td, index) => {
                    td.style.padding = originalPaddings[index];
                });
                if (tabelaDiv && removeClasse) {
                    tabelaDiv.classList.add('escala-visual-menor');
                }
            });
        }

        // Exportar escala mensal para PDF
        function exportarPDFMensal() {
            const element = document.getElementById('elemento-da-escala');
            const options = {
              margin:       [5, 5, 5, 5], // margens pequenas
              filename:     'escala-mensal.pdf',
              image:        { type: 'jpeg', quality: 0.98 },
              html2canvas:  { scale: 2, useCORS: true },
              jsPDF:        { unit: 'mm', format: 'a4', orientation: 'landscape' }
            };
            html2pdf().set(options).from(element).save();   
        }

        // Exportar escala semanal para PDF
        function exportarPDFSemanal() {
            const escalaSemanalOutput = document.getElementById('escalaSemanalOutput');
    const setor = document.getElementById('setorEscalaSemanal').value || 'Todos';
    const dataInicio = moment(document.getElementById('dataInicioSemana').value).format('DD/MM/YYYY');
    const dataFim = moment(document.getElementById('dataInicioSemana').value).add(6, 'days').format('DD/MM/YYYY');
    
    if (!escalaSemanalOutput.innerHTML.trim()) {
        alert('Por favor, gere a escala semanal antes de exportar para PDF.');
        return;
    }
    
    // Carregar configuração do logo
    const configLogo = JSON.parse(localStorage.getItem('escala_config')) || {};
    const logoImg = configLogo.logoImg || '';
    const logoWidth = configLogo.logoWidth || 120;
    const logoHeight = configLogo.logoHeight || 64;
    
    // Criar um elemento temporário para o PDF
    const pdfContent = document.createElement('div');
    
    // Adicionar o logo (opcional)
    if (logoImg) {
        const logo = document.createElement('img');
        logo.src = logoImg;
        logo.alt = 'Logo';
        logo.style.width = logoWidth + 'px';
        logo.style.height = logoHeight + 'px';
        logo.style.objectFit = 'contain';
        logo.style.display = 'block';
        logo.style.margin = '0 auto 10px auto';
        pdfContent.appendChild(logo);
    }
    
    // Adicionar o título "Escala Semanal - (setor)"
    const titulo = document.createElement('h1');
    titulo.style.textAlign = 'center';
    titulo.style.fontSize = '22px';
    titulo.style.fontWeight = 'bold';
    titulo.style.marginBottom = '5px';
    titulo.textContent = `Escala Semanal - ${setor}`;
    pdfContent.appendChild(titulo);

    // Adicionar o período abaixo do título com fonte menor
    const periodo = document.createElement('div');
    periodo.style.textAlign = 'center';
    periodo.style.fontSize = '13px'; // Fonte menor

    periodo.style.marginBottom = '15px';
    periodo.textContent = `Período: ${dataInicio} a ${dataFim}`;
    pdfContent.appendChild(periodo);
    
    // Clonar o conteúdo da escala semanal
    const escalaClone = escalaSemanalOutput.cloneNode(true);

    // Remove títulos antigos do clone
    const titulos = escalaClone.querySelectorAll('h2');
    titulos.forEach(t => {
        if (t.textContent && t.textContent.includes('Escala Semanal')) {
            t.remove();
        }
    });

    // Remove qualquer imagem do clone (logo)
    const imgs = escalaClone.querySelectorAll('img');
    imgs.forEach(img => img.remove());

    // Adicione o clone limpo ao conteúdo do PDF
    pdfContent.appendChild(escalaClone);

    // Configurar opções para o PDF
    const opt = {
        margin: [15, 5, 5, 5], // margem superior maior
        filename: 'escala-semanal.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
    };

    // Gerar o PDF
    html2pdf().from(pdfContent).set(opt).save();
        }

        // Gerar escala semanal
        function gerarEscalaSemanal(modoEdicao = false, folgasManual = {}) {
            const setor = document.getElementById('setorEscalaSemanal').value;
            const dataInicio = document.getElementById('dataInicioSemana').value;
    
            if (!setor || !dataInicio) {
                alert('Por favor, selecione o setor e a data de início.');
                return;
            }

            const funcionarios = db.exec(`SELECT * FROM funcionarios WHERE setor = '${setor}'`)[0];
            if (!funcionarios) {
                document.getElementById('escalaSemanalOutput').innerHTML = 'Nenhum funcionário encontrado para este setor.';

                return;
            }
            
            // Carregar configuração do logo
            const configLogo = JSON.parse(localStorage.getItem('escala_config')) || {};
            const logoImg = configLogo.logoImg || '';
            const logoWidth = configLogo.logoWidth || 120;
            const logoHeight = configLogo.logoHeight || 64;
            
            // Adicionar logo e título
            let html = `
            <div class="flex items-center mb-4">
                ${logoImg ? `<img src="${logoImg}" alt="Logo" style="width:${logoWidth}px;height:${logoHeight}px;object-fit:contain;" class="bg-white rounded shadow mr-4">` : ''}
                <h2 class="text-xl font-bold">${setor} - Escala Semanal</h2>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-7 gap-4">`;
    
            for (let i = 0; i < 7; i++) {
                const dia = moment(dataInicio).add(i, 'days');
                const diaStr = dia.format('YYYY-MM-DD');
                
                // Verificar se é domingo ou feriado para aplicar a cor de fundo correta
                let bgColorClass = "bg-white";
                
                // Verificar se é feriado
                const ehFeriado = getFeriados(dia.year()).some(f => f.data.isSame(dia, 'day'));
                if (ehFeriado) {
                    bgColorClass = "bg-orange-200"; // Laranja claro para feriados
                }
                // Verificar se é domingo
                else if (dia.day() === 0) {
                    bgColorClass = "bg-red-200"; // Vermelho claro para domingos
                }
        
                html += `<div class="${bgColorClass} p-4 rounded shadow">`;
                html += `<h3 class="font-semibold mb-2">${dia.format('DD/MM (ddd)')}${ehFeriado ? ' - Feriado' : ''}</h3>`;
        
                html += '<ul class="space-y-1">';
        
                // Filtrar funcionários disponíveis (sem férias e folgas fixas)
                // Também vamos identificar quem está de folga para exibir separadamente
                let funcionariosDisponiveis = [];
                let funcionariosEmFolga = [];
                
                funcionarios.values.forEach(func => {
                    // Verificar férias
                    if (func[9]) {
                        const dataFerias = moment(func[9]);
                        const diasFerias = func[10] || 0;
                        if (dia.isBetween(dataFerias, moment(dataFerias).add(diasFerias, 'days'), null, '[]')) {
                            // Em férias - não incluir em nenhuma lista
                            return;
                        }
                    }
                    
                    // Verificar tipo de escala e aplicar regras específicas
                    const tipoEscala = func[14] || ''; // Índice 14 para tipoEscala
                    let ehFolga = false;
                    let tipoFolga = '';
                    
                    // Se não tiver tipo de escala definido, usar regra padrão de folga semanal
                    if (!tipoEscala) {
                        // Verificar folga semanal
                        const dataFolgaSemanal = moment(func[6]);
                        const diasDesdefolga = dia.diff(dataFolgaSemanal, 'days');
                        if (diasDesdefolga >= 0 && diasDesdefolga % 7 === 0) {
                            ehFolga = true;
                            tipoFolga = 'F';
                        }
                        
                        // Verificar folga de domingo corretamente
                        if (dia.day() === 0) { // Se for domingo
                            const dataFolgaDomingo = moment(func[7]); // Data da primeira folga de domingo
                            if (dataFolgaDomingo.isValid() && dia.isSameOrAfter(dataFolgaDomingo, 'day')) {
                                // Cálculo do ciclo de 3 semanas (21 dias) a partir da primeira folga de domingo
                                const diffDays = dia.diff(dataFolgaDomingo, 'days');
                                if (diffDays % 3 === 0) {
                                    ehFolga = true;
                                    tipoFolga = 'FD';
                                }
                            }
                        }
                    } else {
                        // Aplicar regras específicas para cada tipo de escala
                        const dataFolgaSemanal = moment(func[6]); // Data de referência para início da contagem
                        if (!dataFolgaSemanal.isValid()) {
                            // Se não tiver data de referência, sempre disponível
                            funcionariosDisponiveis.push(func);
                            return;
                        }
                        
                        const diasDesdeInicio = dia.diff(dataFolgaSemanal, 'days');
                        
                        switch(tipoEscala) {
                            case '6x1': // 6 dias de trabalho, 1 de folga
                                // Regra padrão para dias de semana: folga a cada 7 dias
                                if (diasDesdeInicio % 7 === 0) {
                                    ehFolga = true;
                                    tipoFolga = 'F';
                                }
                                
                                // Regra especial para domingos: a cada 2 domingos trabalhados, folga o terceiro
                                if (dia.day() === 0) {
                                }
                                
                                // Regra especial para domingos: a cada 2 domingos trabalhados, folga o terceiro
                                if (dia.day() === 0) {
                                    const dataFolgaDomingo = moment(func[7]); // Data da primeira folga de domingo
                                    if (dataFolgaDomingo.isValid()) {
                                        // Calcula quantos domingos se passaram desde a data de referência
                                        const domingosDesdeFolga = Math.floor(dia.diff(dataFolgaDomingo, 'days') / 7);
                                        // A cada 3 domingos (0, 3, 6, 9...), é folga
                                        // A cada 3 domingos (0, 3, 6, 9...), é folga
                                        if (domingosDesdeFolga % 3 === 0 && dia.isSameOrAfter(dataFolgaDomingo)) {
                                            ehFolga = true;
                                            tipoFolga = 'FD';
                                        }
                                    }
                                }
                                break;
                                
                            case '5x2': // 5 dias de trabalho, 2 de folga
                                if (diasDesdeInicio % 7 === 0 || diasDesdeInicio % 7 === 6) {
                                    ehFolga = true;
                                    tipoFolga = 'F';
                                }
                                break;
                                
                            case '4x2': // 4 dias de trabalho, 2 de folga
                                if (diasDesdeInicio % 6 === 0 || diasDesdeInicio % 6 === 5) {
                                    ehFolga = true;
                                    tipoFolga = 'F';
                                }
                                break;
                                
                            case '4x3': // 4 dias de trabalho, 3 de folga
                                if (diasDesdeInicio % 7 === 0 || diasDesdeInicio % 7 === 6 || diasDesdeInicio % 7 === 5) {
                                    ehFolga = true;
                                    tipoFolga = 'F';
                                }
                                break;
                                
                            case '12x36': // 12 horas de trabalho, 36 horas de folga (1 dia sim, 1 dia não)
                                if (diasDesdeInicio % 2 === 0) {
                                    ehFolga = true;
                                    tipoFolga = 'F';
                                }
                                break;
                                
                            case '12x24': // 12 horas de trabalho, 24 horas de folga
                                // Trabalha 1 dia, folga 1 dia, mas com ciclo de 2 dias
                                if (diasDesdeInicio % 2 === 0) {
                                    ehFolga = true;
                                    tipoFolga = 'F';
                                }
                                break;
                                
                            case '6x2': // 6 dias de trabalho, 2 de folga
                                if (diasDesdeInicio % 8 === 0 || diasDesdeInicio % 8 === 7) {
                                    ehFolga = true;
                                    tipoFolga = 'F';
                                }
                                break;
                                
                            case '24x72': // 24 horas de trabalho, 72 horas de folga (1 dia sim, 3 dias não)
                                if ([0,1,2].includes(diasDesdeInicio % 4)) ehFolga = true;
                                break;
                                
                            case '3x3': // 3 dias de trabalho, 3 de folga
                                if ((diasDesdeInicio % 6) >= 3) ehFolga = true;
                                break;
                                
                            case '2x2': // 2 dias de trabalho, 2 de folga
                                if ((diasDesdeInicio % 4) >= 2) ehFolga = true;
                                break;
                                
                            case '5x1': // 5 dias de trabalho, 1 de folga
                                if (diasDesdeInicio % 6 === 0) ehFolga = true;
                                break;
                        }
                    }
            
                    // Adicionar à lista apropriada
                    if (ehFolga) {
                        funcionariosEmFolga.push({
                            ...func,
                            tipoFolga: tipoFolga
                        });
                    } else {
                        funcionariosDisponiveis.push(func);
                    }
                });
        
                // Mapear funcionários com informações necessárias
                let funcionariosInfo = funcionariosDisponiveis.map(func => ({
                    nome: func[2].split(' ')[0], // Apenas primeiro nome
                    nomeCompleto: func[2],
                    horaEntrada: horariosPersonalizados[diaStr]?.[func[2]] || func[12], // Corrigido o índice para horaEntrada
                    estaDeFolga: folgasManual[diaStr]?.[func[2]] ? true : false,
                    tipoFolga: folgasManual[diaStr]?.[func[2]] || 'FF'
                }));
        
                // Separar funcionários ativos e de folga manual
                let funcionariosAtivos = funcionariosInfo.filter(f => !f.estaDeFolga);
                let funcionariosFolga = funcionariosInfo.filter(f => f.estaDeFolga);
        
                // Ordenar por horário de entrada
                funcionariosAtivos.sort((a, b) => a.horaEntrada.localeCompare(b.horaEntrada));
        
                // Exibir funcionários ativos
                funcionariosAtivos.forEach(func => {
                    if (modoEdicao) {
                        html += `<li>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" 
                                    data-dia="${diaStr}" 
                                    data-nome="${func.nomeCompleto}" 
                                    onchange="marcarFolgaManual(this)">
                                <span>${func.nome}</span>
                                <button onclick="alterarHorario('${diaStr}', '${func.nomeCompleto}')" 
                                    class="ml-2 px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600">
                                    ${func.horaEntrada}
                                </button>
                            </label>
                        </li>`;
                    } else {
                        html += `<li>${func.nome} (${func.horaEntrada})</li>`;
                    }
                });
        
                // Adicionar linha divisória se houver folgas manuais
                if (funcionariosFolga.length > 0) {
                    html += '<li class="border-t border-gray-300 my-2"></li>';
                }
        
                // Exibir funcionários com folga manual
                funcionariosFolga.forEach(func => {
                    if (modoEdicao) {
                        html += `<li>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" 
                                    checked
                                    data-dia="${diaStr}" 
                                    data-nome="${func.nomeCompleto}" 
                                    onchange="marcarFolgaManual(this)">
                                <span class="text-red-500 font-bold">${func.nome} (${func.tipoFolga})</span>
                            </label>
                        </li>`;
                    } else {
                        html += `<li class="text-red-500 font-bold">${func.nome} (${func.tipoFolga})</li>`;
 }
                });

                html += '</ul></div>';
            }
    
            html += '</div>';
            document.getElementById('escalaSemanalOutput').innerHTML = html;
        }

        // Mostrar aba de configuração
        function mostrarAbaConfig(aba) {
            // Esconder todas as abas
            document.querySelectorAll('.config-tab').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remover destaque de todos os botões
            document.querySelectorAll('#popupConfig .border-b button').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent');
            });
            
            // Mostrar a aba selecionada
            document.getElementById('config' + aba.charAt(0).toUpperCase() + aba.slice(1)).classList.remove('hidden');
            
            // Destacar o botão selecionado
            event.currentTarget.classList.add('border-blue-500', 'text-blue-600');
            event.currentTarget.classList.remove('border-transparent');
        }
        
        // Funções para o popup de configuração
        function abrirPopupConfig() {
            // Carregar usuários e permissões
            carregarUsuarios();
            carregarPermissoes();
            
            // Verificar se o usuário é Admin
            const isAdmin = usuarioLogado === 'Admin';
            
            // Configurar visibilidade das abas com base no tipo de usuário
            const abaGeralBtn = document.querySelector('#popupConfig .border-b button:nth-child(1)');
            const abaUsuariosBtn = document.querySelector('#popupConfig .border-b button:nth-child(2)');
            const abaPermissoesBtn = document.querySelector('#popupConfig .border-b button:nth-child(3)');
            
            if (!isAdmin) {
                // Usuário normal - esconder abas de geral e permissões
                abaGeralBtn.classList.add('hidden');
                abaPermissoesBtn.classList.add('hidden');
                
                // Esconder a tabela de usuários e o formulário para adicionar usuários
                const tabelaUsuarios = document.querySelector('#configUsuarios .overflow-x-auto');
                const formAddUsuario = document.querySelector('#configUsuarios .grid.grid-cols-1.md\\:grid-cols-2');
                const btnAddUsuario = document.querySelector('#configUsuarios button.bg-green-500');
                
                if (tabelaUsuarios) tabelaUsuarios.classList.add('hidden');
                if (formAddUsuario) formAddUsuario.classList.add('hidden');
                if (btnAddUsuario) btnAddUsuario.classList.add('hidden');
                
                // Mostrar apenas a seção de alteração de senha
                document.getElementById('configUsuarios').classList.remove('hidden');
                
                // Atualizar título da aba
                document.querySelector('#popupConfig h3').textContent = 'Alterar Senha';
                
                // Mostrar a aba de usuários por padrão
                abaUsuariosBtn.click();
            } else {
                // Admin - mostrar todas as abas
                abaGeralBtn.classList.remove('hidden');
                abaUsuariosBtn.classList.remove('hidden');
                abaPermissoesBtn.classList.remove('hidden');
                
                // Mostrar tabela de usuários e formulário para adicionar usuários
                const tabelaUsuarios = document.querySelector('#configUsuarios .overflow-x-auto');
                const formAddUsuario = document.querySelector('#configUsuarios .grid.grid-cols-1.md\\:grid-cols-2');
                const btnAddUsuario = document.querySelector('#configUsuarios button.bg-green-500');
                
                if (tabelaUsuarios) tabelaUsuarios.classList.remove('hidden');
                if (formAddUsuario) formAddUsuario.classList.remove('hidden');
                if (btnAddUsuario) btnAddUsuario.classList.remove('hidden');
                
                // Atualizar título da aba
                document.querySelector('#popupConfig h3').textContent = 'Configuração';
                
                // Mostrar a primeira aba por padrão
                abaGeralBtn.click();
                
                // Adicionar botão para salvar configuração do primeiro dia da escala
                const btnSalvarDiaEscala = document.getElementById('btnSalvarDiaEscala');
                if (!btnSalvarDiaEscala) {
                    const divPrimeiroDia = document.querySelector('#configGeral .grid > div:first-child');
                    if (divPrimeiroDia) {
                        const btnSalvar = document.createElement('button');
                        btnSalvar.id = 'btnSalvarDiaEscala';
                        btnSalvar.className = 'px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 mt-2';
                        btnSalvar.textContent = 'Salvar';
                        btnSalvar.onclick = salvarPrimeiroDiaEscala;
                        divPrimeiroDia.appendChild(btnSalvar);
                    }
                }
            }
            
            // Exibir o popup
            document.getElementById('popupConfig').classList.remove('hidden');
        }
        
        function fecharPopupConfig() {
            document.getElementById('popupConfig').classList.add('hidden');
        }
        
        function salvarConfiguracaoPopup() {
            // Salvar primeiro dia da escala
            const primeiroDiaEscala = document.getElementById('primeiroDiaEscalaPopup').value;
            const logoWidth = document.getElementById('logoWidthPopup').value;
            const logoHeight = document.getElementById('logoHeightPopup').value;
            const logoInput = document.getElementById('logoInputPopup');
            // Carregar configuração existente ou criar nova
            let config = JSON.parse(localStorage.getItem('escala_config')) || {};
            config.primeiroDia = primeiroDiaEscala;
            config.logoWidth = logoWidth;
            config.logoHeight = logoHeight;

            function finalizar(config) {
                localStorage.setItem('escala_config', JSON.stringify(config));
                carregarLogoSalvo(); // Atualiza logo no topo
                fecharPopupConfig();
                alert('Configurações salvas com sucesso!');
            }

            if (logoInput.files.length > 0) {
                const file = logoInput.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    config.logoImg = e.target.result;
                    finalizar(config);
                };
                reader.readAsDataURL(file);
            } else {
                finalizar(config);
            }
        }
        
        // Função para atualizar a paginação
        function atualizarPaginacao() {
            const totalPaginas = Math.ceil(funcionariosFiltrados.length / itensPorPagina);
            document.getElementById('paginaAtual').textContent = paginaAtual;
            document.getElementById('totalPaginas').textContent = totalPaginas;
            
            // Habilitar/desabilitar botões de navegação
            document.getElementById('btnPaginaAnterior').disabled = paginaAtual <= 1;
            document.getElementById('btnProximaPagina').disabled = paginaAtual >= totalPaginas;
            
            // Exibir funcionários da página atual
            exibirFuncionariosPaginados();
        }
        
        // Função para exibir funcionários da página atual
        function exibirFuncionariosPaginados() {
            const inicio = (paginaAtual - 1) * itensPorPagina;
            const fim = inicio + itensPorPagina;
            const funcionariosPagina = funcionariosFiltrados.slice(inicio, fim);
            
            renderizarFuncionarios(funcionariosPagina);
        }
        
        // Função para ir para a página anterior
        function paginaAnterior() {
            if (paginaAtual > 1) {
                paginaAtual--;
                atualizarPaginacao();
            }
        }
        
        // Função para ir para a próxima página
        function proximaPagina() {
            const totalPaginas = Math.ceil(funcionariosFiltrados.length / itensPorPagina);
            if (paginaAtual < totalPaginas) {
                paginaAtual++;
                atualizarPaginacao();
            }
        }
        
        // Inicializar sistema de autenticação
        function initAuth() {
            // Verificar se já existem usuários no localStorage
            const usuariosSalvos = localStorage.getItem('usuariosRegistrados');
            if (usuariosSalvos) {
                usuariosRegistrados = JSON.parse(usuariosSalvos);
            } else {
                // Criar usuário Admin padrão se não existir nenhum usuário
                usuariosRegistrados = [
                    { usuario: 'Admin', senha: '123456' }
                ];
                salvarUsuarios();
            }
    
            // Verificar se já existem permissões no localStorage
            const permissoesSalvas = localStorage.getItem('permissoesUsuarios');
            if (permissoesSalvas) {
                permissoesUsuarios = JSON.parse(permissoesSalvas);
            } else {
                // Criar permissões padrão para o Admin
                permissoesUsuarios = [
                    { usuario: 'Admin', adicionarUsuarios: true, adicionarFuncionarios: true, editarFuncionarios: true }
                ];
                salvarPermissoes();
            }
            
            // Carregar configuração do primeiro dia da escala
            const diaEscalaSalvo = localStorage.getItem('primeiroDiaEscala');
            if (diaEscalaSalvo) {
                primeiroDiaEscala = parseInt(diaEscalaSalvo);
                if (document.getElementById('primeiroDiaEscalaPopup')) {
                    document.getElementById('primeiroDiaEscalaPopup').value = primeiroDiaEscala;
                }
            }
            
            // Verificar se há um usuário logado na sessão
            const sessaoUsuario = sessionStorage.getItem('usuarioLogado');
            if (sessaoUsuario) {
                usuarioLogado = sessaoUsuario;
                mostrarConteudoPrincipal();
            }
        }
        
        // Salvar usuários no localStorage
        function salvarUsuarios() {
            localStorage.setItem('usuariosRegistrados', JSON.stringify(usuariosRegistrados));
        }
        
        // Salvar permissões no localStorage
        function salvarPermissoes() {
            localStorage.setItem('permissoesUsuarios', JSON.stringify(permissoesUsuarios));
        }
        
        // Salvar configuração do primeiro dia da escala
        function salvarPrimeiroDiaEscala() {
            const dia = parseInt(document.getElementById('primeiroDiaEscalaPopup').value);
            primeiroDiaEscala = dia;
            localStorage.setItem('primeiroDiaEscala', dia);
            alert('Configuração salva com sucesso!');
        }
        
        // Fazer login
        function fazerLogin(event) {
            event.preventDefault();
            
            const usuario = document.getElementById('loginUsuario').value;
            const senha = document.getElementById('loginSenha').value;
            
            const usuarioValido = usuariosRegistrados.find(u => 
                u.usuario === usuario && u.senha === senha
            );
            
            if (usuarioValido) {
                usuarioLogado = usuario;
                sessionStorage.setItem('usuarioLogado', usuario);
                mostrarConteudoPrincipal();
            } else {
                document.getElementById('loginErro').classList.remove('hidden');
                setTimeout(() => {
                    document.getElementById('loginErro').classList.add('hidden');
                }, 3000);
            }
            
            return false;
        }
        
        // Mostrar conteúdo principal após login
        function mostrarConteudoPrincipal() {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('conteudoPrincipal').classList.remove('hidden');
        }
        
        // Fazer logout
        function fazerLogout() {
            usuarioLogado = null;
            sessionStorage.removeItem('usuarioLogado');
            document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('conteudoPrincipal').classList.add('hidden');
            document.getElementById('loginUsuario').value = '';
            document.getElementById('loginSenha').value = '';
        }
        
        // Adicionar novo usuário
        function adicionarUsuario() {
            // Verificar se o usuário tem permissão
            if (!temPermissao('adicionarUsuarios')) {
                alert('Você não tem permissão para adicionar usuários!');
                return;
            }
            
            const novoUsuario = document.getElementById('novoUsuario').value.trim();
            const novaSenha = document.getElementById('novaSenha').value.trim();
            
            if (!novoUsuario || !novaSenha) {
                alert('Por favor, preencha o usuário e a senha!');
                return;
            }
            
            // Verificar se o usuário já existe
            if (usuariosRegistrados.some(u => u.usuario === novoUsuario)) {
                alert('Este usuário já existe!');
                return;
            }
            
            // Adicionar novo usuário
            usuariosRegistrados.push({ usuario: novoUsuario, senha: novaSenha });
            salvarUsuarios();
            
            // Adicionar permissões padrão para o novo usuário
            permissoesUsuarios.push({ 
                usuario: novoUsuario, 
                adicionarUsuarios: false,
                adicionarFuncionarios: false, 
                editarFuncionarios: false 
            });
            salvarPermissoes();
            
            // Limpar campos
            document.getElementById('novoUsuario').value = '';
            document.getElementById('novaSenha').value = '';
            
            // Atualizar tabelas
            carregarUsuarios();
            carregarPermissoes();
            
            alert('Usuário adicionado com sucesso!');
        }
        
        // Remover usuário
        function removerUsuario(usuario) {
            // Verificar se o usuário tem permissão
            if (!temPermissao('adicionarUsuarios')) {
                alert('Você não tem permissão para remover usuários!');
                return;
            }
            
            // Não permitir remover o Admin
            if (usuario === 'Admin') {
                alert('Não é possível remover o usuário Admin!');
                return;
            }
            
            if (confirm(`Tem certeza que deseja remover o usuário ${usuario}?`)) {
                usuariosRegistrados = usuariosRegistrados.filter(u => u.usuario !== usuario);
                salvarUsuarios();
                
                permissoesUsuarios = permissoesUsuarios.filter(p => p.usuario !== usuario);
                salvarPermissoes();
                
                carregarUsuarios();
                carregarPermissoes();
            }
        }
        
        // Alterar senha do usuário logado
        function alterarSenha() {
            const senhaAtual = document.getElementById('senhaAtual').value;
            const novaSenha = document.getElementById('novaSenhaUsuario').value;
            
            if (!senhaAtual || !novaSenha) {
                alert('Por favor, preencha todos os campos!');
                return;
            }
            
            // Verificar senha atual
            const usuario = usuariosRegistrados.find(u => u.usuario === usuarioLogado);
            if (!usuario || usuario.senha !== senhaAtual) {
                alert('Senha atual incorreta!');
                return;
            }
            
            // Alterar senha
            usuario.senha = novaSenha;
            salvarUsuarios();
            
            // Limpar campos
            document.getElementById('senhaAtual').value = '';
            document.getElementById('novaSenhaUsuario').value = '';
            
            alert('Senha alterada com sucesso!');
        }
        
        // Carregar usuários na tabela
        function carregarUsuarios() {
            const tabela = document.getElementById('usuariosTable');
            if (!tabela) return;
            
            tabela.innerHTML = '';
            
            usuariosRegistrados.forEach(u => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-3">${u.usuario}</td>
                    <td class="p-3">
                        <button class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 ${u.usuario === 'Admin' ? 'opacity-50 cursor-not-allowed' : ''}" 
                            onclick="removerUsuario('${u.usuario}')" 
                            ${u.usuario === 'Admin' ? 'disabled' : ''}>
                            Remover
                        </button>
                    </td>
                `;
                tabela.appendChild(tr);
            });
        }
        
        // Carregar permissões na tabela
        function carregarPermissoes() {
            const tabela = document.getElementById('permissoesTable');
            if (!tabela) return;
            
            tabela.innerHTML = '';
            
            usuariosRegistrados.forEach(u => {
                const permissao = permissoesUsuarios.find(p => p.usuario === u.usuario) || {
                    usuario: u.usuario,
                    adicionarUsuarios: false,
                    adicionarFuncionarios: false,
                    editarFuncionarios: false
                };
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-3">${u.usuario}</td>
                    <td class="p-3 text-center">
                        <input type="checkbox" 
                            ${permissao.adicionarUsuarios ? 'checked' : ''} 
                            ${u.usuario === 'Admin' ? 'disabled' : ''} 
                            onchange="alterarPermissao('${u.usuario}', 'adicionarUsuarios', this.checked)">
                    </td>
                    <td class="p-3 text-center">
                        <input type="checkbox" 
                            ${permissao.adicionarFuncionarios ? 'checked' : ''} 
                            ${u.usuario === 'Admin' ? 'disabled' : ''} 
                            onchange="alterarPermissao('${u.usuario}', 'adicionarFuncionarios', this.checked)">
                    </td>
                    <td class="p-3 text-center">
                        <input type="checkbox" 
                            ${permissao.editarFuncionarios ? 'checked' : ''} 
                            ${u.usuario === 'Admin' ? 'disabled' : ''} 
                            onchange="alterarPermissao('${u.usuario}', 'editarFuncionarios', this.checked)">
                    </td>
                `;
                tabela.appendChild(tr);
            });
        }
        
        // Alterar permissão de um usuário
        function alterarPermissao(usuario, tipo, valor) {
            // Verificar se o usuário tem permissão
            if (!temPermissao('adicionarUsuarios')) {
                alert('Você não tem permissão para alterar permissões!');
                return;
            }
            
            let permissao = permissoesUsuarios.find(p => p.usuario === usuario);
            
            if (!permissao) {
                permissao = {
                    usuario: usuario,
                    adicionarUsuarios: false,
                    adicionarFuncionarios: false,
                    editarFuncionarios: false
                };
                permissoesUsuarios.push(permissao);
            }
            
            permissao[tipo] = valor;
            salvarPermissoes();
        }
        
        // Verificar permissão do usuário logado
        function temPermissao(tipo) {
            if (usuarioLogado === 'Admin') return true;
            
            const permissao = permissoesUsuarios.find(p => p.usuario === usuarioLogado);
            return permissao && permissao[tipo];
        }
        
        // Inicializar
        initDb();
        carregarConfiguracao();
        carregarFolgasManuais();
        carregarHorariosPersonalizados();
        showTab('gerenciar');

        const input = document.getElementById('input-imagem');
if (input) {
  input.addEventListener('change', function(e) {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = function(event) {
      document.getElementById('imagem-exibida').src = event.target.result;
    };
    reader.readAsDataURL(file);
  });
}
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
        </div>
</body>
<footer style="text-align: center;">
    <p style="font-size: 10px;">criado por <b>Gean Marcell</b> em 05/2025</p>
</footer>
</html>